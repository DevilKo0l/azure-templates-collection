{
    "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
    "contentVersion": "1.0.0.0",
    "parameters": {
        "appServicePlanName": {
            "type": "string"
        },
        "planSKU":{
            "type": "string",
            "allowedValues":[
                "B1", "S1", "P1v3", "P2v3"
            ]
        },
        "appServiceName":{
            "type": "string"
        },
        "appNumber":{
            "type": "int"
        },
        "stage": {
            "type": "string",
            "allowedValues":[
                "prod", "staging", "dev"
            ]
        },
        "networkPurpose": {
            "type": "string",
            "allowedValues":[
                "shared","prod","client"
            ]
        },
        "networkRegion":{
            "type": "string",
            "defaultValue": "[resourceGroup().location]"
        },
        
        "subnet1Name":{
            "type": "string"
            
        },
        "subnet2Name":{
            "type": "string"
        },
        "nsgPurpose":{
            "type": "string"
        },

        "virtualNetworkCIDR":{
            "type": "string",
            "defaultValue": "10.0.0.0/16"
        },

        "subnet1CIDR":{
            "type": "string",
            "defaultValue": "10.0.1.0/24"
        },
        "subnet2CIDR":{
            "type": "string",
            "defaultValue": "10.0.2.0/24"
        },
        "privateEndpointName": {
            "type": "string"
        },
        "nsg1Name":{
            "type": "string"
        },
        "privateLinkConnectionName":{
            "type": "string"
        }

    },
    "functions": [],
    "variables": {
        "appServiceDNSLabel": ".azurewebsites.net",
        "appServicePrivateDNSLabel": ".privatelink.azurewebsites.net",
        // asp-<project, app or service>-<environment>-<###>
        "appServicePlanName": "[concat('asp','-',parameters('appServicePlanName'),'-',parameters('stage'),'-','00',parameters('appNumber'))]",
        // app-<project, app or service>-<environment>-<###>.azurewebsites.net
        "appServiceName": "[concat('app','-',parameters('appServiceName'),'-',parameters('stage'),'-','00',parameters('appNumber'))]",
        // vnet-<network purpose>-<network region>-<###>
        "virtualNetworkName": "[concat('vnet','-',parameters('networkPurpose'),'-',parameters('networkRegion'),'-','00',parameters('appNumber'))]",
        // 	snet-<subnet purpose>-<region>-<###>
        "subnet1Name": "[concat('snet','-',parameters('subnet1Name'),'-',parameters('networkPurpose'),'-',parameters('networkRegion'),'-','00',parameters('appNumber'))]",
        "subnet2Name": "[concat('snet','-',parameters('subnet2Name'),'-',parameters('networkPurpose'),'-',parameters('networkRegion'),'-','00',parameters('appNumber'))]",

        // pe-<pePurpose>-<region>-<###>
        "privateEndpointName":"[concat('pe','-',parameters('privateEndpointName'),'-',parameters('networkPurpose'),'-',parameters('networkRegion'),'-','00',parameters('appNumber'))]",
        "networkSecurityGroupName":"[concat('nsg','-',parameters('nsgPurpose'),'-',parameters('networkRegion'),'-','00',parameters('appNumber'))]"
    },
    "resources": [
        //App service template
        {
            "name": "[variables('appServicePlanName')]",
            "type": "Microsoft.Web/serverfarms",
            "apiVersion": "2023-01-01",
            "location": "[resourceGroup().location]",
            "sku": {
                "name": "[parameters('planSKU')]"                
            },           
            "properties": {
                "name": "appServicePlan1"
            }
        },

        {
            "name": "[variables('appServiceName')]",
            "type": "Microsoft.Web/sites",
            "apiVersion": "2023-01-01",
            "location": "[resourceGroup().location]",           
            "dependsOn": [
                "[resourceId('Microsoft.Web/serverfarms', variables('appServicePlanName'))]"
            ],
            "properties": {                
                "serverFarmId": "[resourceId('Microsoft.Web/serverfarms', variables('appServicePlanName'))]"
            }
        },
        {
            "type": "Microsoft.Web/sites/config",
            "apiVersion": "2023-11-01",
            "name": "[format('{0}/{1}', variables('appServiceName'), 'web')]",
            "properties": {
                "ftpsState": "AllAllowed",
                "alwaysOn": true,
                "use32BitWorkerProcess": true
            },
            "dependsOn": [
                "[resourceId('Microsoft.Web/sites', variables('appServiceName'))]"
            ]
        },
        // Virtual network template
        {
            "name": "[variables('virtualNetworkName')]",
            "type": "Microsoft.Network/virtualNetworks",
            "apiVersion": "2023-11-01",
            "location": "[resourceGroup().location]",           
            "dependsOn": [
                "[resourceId('Microsoft.Network/networkSecurityGroups', variables('networkSecurityGroupName'))]"
            ],
            "properties": {
                "addressSpace": {
                    "addressPrefixes": [
                        "[parameters('virtualNetworkCIDR')]"
                    ]
                },
                "subnets": [
                    {
                        "name": "[variables('subnet1Name')]",
                        "properties": {
                            "addressPrefix": "[parameters('subnet1CIDR')]"
                           
                        }
                    },
                    {
                        "name": "[variables('subnet2Name')]",
                        "properties": {
                            "addressPrefix": "[parameters('subnet2CIDR')]"                            
                        }
                    }
                ]
            }
        },
        {
            "name": "[variables('privateEndpointName')]",
            "type": "Microsoft.Network/privateEndpoints",
            "apiVersion": "2023-11-01",
            
            "location": "[resourceGroup().location]",
            "properties": {
                "subnet": {
                "id": "[resourceId('Microsoft.Network/virtualNetworks/subnets', variables('virtualNetworkName'), variables('subnet1Name'))]"
                },
                "privateLinkServiceConnections": [
                {
                    "name": "[parameters('privateLinkConnectionName')]",
                    "properties": {
                    "privateLinkServiceId": "[resourceId('Microsoft.Web/sites', variables('appServiceName'))]",
                    "groupIds": [
                        "sites"
                    ]
                    }
                }
                ]
            },
            "dependsOn": [
                "[resourceId('Microsoft.Network/virtualNetworks', variables('virtualNetworkName'))]",
                "[resourceId('Microsoft.Web/sites', variables('appServiceName'))]"
            ]
    },
    {
      "type": "Microsoft.Network/privateDnsZones",
      "apiVersion": "2023-11-01",
      "name": "[variables('appServicePrivateDNSLabel')]",
      "location": "global",
      "dependsOn": [
        "[resourceId('Microsoft.Network/virtualNetworks', variables('virtualNetworkName'))]"
      ]
    },
    {
      "type": "Microsoft.Network/privateDnsZones/virtualNetworkLinks",
      "apiVersion": "2018-09-01",
      "name": "[format('{0}/{1}', 'link',variables('appServicePrivateDNSLabel'))]",
      "location": "global",
      "properties": {
        "registrationEnabled": false,
        "virtualNetwork": {
          "id": "[resourceId('Microsoft.Network/virtualNetworks', variables('appServicePrivateDNSLabel'))]"
        }
      },
      "dependsOn": [
        "[resourceId('Microsoft.Network/privateDnsZones', variables('appServicePrivateDNSLabel'))]",
        "[resourceId('Microsoft.Network/virtualNetworks', variables('virtualNetworkName'))]"
      ]
    }
    ],
    "outputs": {}
}